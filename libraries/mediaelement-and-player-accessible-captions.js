define(["libraries/mediaelement-and-player"],function(){$.extend(mejs.MepDefaults,{startLanguage:"",tracksText:mejs.i18n.t("Captions/Subtitles"),tracksAriaLive:!1,hideCaptionsButtonWhenEmpty:!0,toggleCaptionsButtonWhenOnlyOne:!1,slidesSelector:""}),$.extend(MediaElementPlayer.prototype,{hasChapters:!1,cleartracks:function(t,e,s,i){t&&(t.captions&&t.captions.remove(),t.chapters&&t.chapters.remove(),t.captionsText&&t.captionsText.remove(),t.captionsButton&&t.captionsButton.remove())},buildtracks:function(t,e,s,i){if(0!==t.tracks.length){var n,a=this,o=a.options.tracksAriaLive?'role="log" aria-live="assertive" aria-atomic="false"':"";if(a.domNode.textTracks)for(n=a.domNode.textTracks.length-1;n>=0;n--)a.domNode.textTracks[n].mode="hidden";a.cleartracks(t,e,s,i),t.chapters=$('<div class="mejs-chapters mejs-layer"></div>').prependTo(s).hide(),t.captions=$('<div class="mejs-captions-layer mejs-layer"><div class="mejs-captions-position mejs-captions-position-hover" '+o+'><span class="mejs-captions-text"></span></div></div>').prependTo(s).hide(),t.captionsText=t.captions.find(".mejs-captions-text"),t.captionsButton=$('<div class="mejs-button mejs-captions-button"><button type="button" aria-controls="'+a.id+'" title="'+a.options.tracksText+'" aria-label="'+a.options.tracksText+'"></button><div class="mejs-captions-selector"><ul><li><input type="checkbox" name="'+t.id+'_captions" id="'+t.id+'_captions_none" value="none" checked="checked" /><label for="'+t.id+'_captions_none">'+mejs.i18n.t("None")+"</label></li></ul></div></div>").appendTo(e);var r=0;for(n=0;n<t.tracks.length;n++)"subtitles"==t.tracks[n].kind&&r++;for(a.options.toggleCaptionsButtonWhenOnlyOne&&1==r?t.captionsButton.on("click",function(){null===t.selectedTrack?lang=t.tracks[0].srclang:lang="none",t.setTrack(lang)}):t.captionsButton.on("click",function(t){$(this).find(".mejs-captions-selector").removeClass("mejs-offscreen").css("visibility","visible"),setTimeout(function(){$($(t.currentTarget).find(".mejs-captions-selector").find("input[type=checkbox]")[0]).focus()},250)}).on("click keyup","input[type=checkbox]",function(e){e.stopPropagation(),"keyup"===e.type&&32!==e.which&&13!==e.which||($(this).parents(".mejs-captions-selector").find("input[type=checkbox]").prop("checked",!1),$(this).prop("checked",!0),lang=this.value,t.setTrack(lang),"keyup"===e.type&&$(this).parents(".mejs-captions-button").find("button").focus(),$(this).parents(".mejs-captions-selector").addClass("mejs-offscreen").css("visibility","hidden"))}),t.options.alwaysShowControls?t.container.find(".mejs-captions-position").addClass("mejs-captions-position-hover"):t.container.bind("controlsshown",function(){t.container.find(".mejs-captions-position").addClass("mejs-captions-position-hover")}).bind("controlshidden",function(){i.paused||t.container.find(".mejs-captions-position").removeClass("mejs-captions-position-hover")}),t.trackToLoad=-1,t.selectedTrack=null,t.isLoadingTrack=!1,n=0;n<t.tracks.length;n++)"subtitles"==t.tracks[n].kind&&t.addTrackButton(t.tracks[n].srclang,t.tracks[n].label);t.loadNextTrack(),i.addEventListener("timeupdate",function(e){t.displayCaptions()},!1),""!==t.options.slidesSelector&&(t.slidesContainer=$(t.options.slidesSelector),i.addEventListener("timeupdate",function(e){t.displaySlides()},!1)),i.addEventListener("loadedmetadata",function(e){t.displayChapters()},!1),t.container.hover(function(){t.hasChapters&&(t.chapters.removeClass("mejs-offscreen"),t.chapters.fadeIn(200).height(t.chapters.find(".mejs-chapter").outerHeight()))},function(){t.hasChapters&&!i.paused&&t.chapters.fadeOut(200,function(){$(this).addClass("mejs-offscreen"),$(this).css("display","block")})}),a.container.on("controlsresize",function(){a.adjustLanguageBox()}),null!==t.node.getAttribute("autoplay")&&t.chapters.addClass("mejs-offscreen")}},setTrack:function(t){var e,s=this;if("none"==t)s.selectedTrack=null,s.captionsButton.removeClass("mejs-captions-enabled");else for(e=0;e<s.tracks.length;e++)if(s.tracks[e].srclang==t){null===s.selectedTrack&&s.captionsButton.addClass("mejs-captions-enabled"),s.selectedTrack=s.tracks[e],s.captions.attr("lang",s.selectedTrack.srclang),s.displayCaptions();break}},loadNextTrack:function(){var t=this;t.trackToLoad++,t.trackToLoad<t.tracks.length?(t.isLoadingTrack=!0,t.loadTrack(t.trackToLoad)):(t.isLoadingTrack=!1,t.checkForTracks())},loadTrack:function(t){var e=this,s=e.tracks[t],i=function(){s.isLoaded=!0,e.enableTrackButton(s.srclang,s.label),e.loadNextTrack()};$.ajax({url:s.src,dataType:"text",success:function(t){"string"==typeof t&&/<tt\s+xml/gi.exec(t)?s.entries=mejs.TrackFormatParser.dfxp.parse(t):s.entries=mejs.TrackFormatParser.webvtt.parse(t),i(),"chapters"==s.kind&&e.media.addEventListener("play",function(t){e.media.duration>0&&e.displayChapters(s)},!1),"slides"==s.kind&&e.setupSlides(s)},error:function(){e.removeTrackButton(s.srclang),e.loadNextTrack()}})},enableTrackButton:function(t,e){var s=this;""===e&&(e=mejs.language.codes[t]||t),s.captionsButton.find("input[value="+t+"]").prop("disabled",!1).siblings("label").html(e),s.options.startLanguage==t&&$("#"+s.id+"_captions_"+t).prop("checked",!0).trigger("click"),s.adjustLanguageBox()},removeTrackButton:function(t){var e=this;e.captionsButton.find("input[value="+t+"]").closest("li").remove(),e.adjustLanguageBox()},addTrackButton:function(t,e){var s=this;""===e&&(e=mejs.language.codes[t]||t),s.captionsButton.find("ul").append($('<li><input type="checkbox" name="'+s.id+'_captions" id="'+s.id+"_captions_"+t+'" value="'+t+'" disabled="disabled" /><label for="'+s.id+"_captions_"+t+'">'+e+" (loading)</label></li>")),s.adjustLanguageBox(),s.container.find(".mejs-captions-translations option[value="+t+"]").remove()},adjustLanguageBox:function(){var t=this;t.captionsButton.find(".mejs-captions-selector").height(t.captionsButton.find(".mejs-captions-selector ul").outerHeight(!0)+t.captionsButton.find(".mejs-captions-translations").outerHeight(!0))},checkForTracks:function(){var t=this,e=!1;if(t.options.hideCaptionsButtonWhenEmpty){for(i=0;i<t.tracks.length;i++)if("subtitles"==t.tracks[i].kind&&t.tracks[i].isLoaded){e=!0;break}e||(t.captionsButton.hide(),t.setControlsSize())}},displayCaptions:function(){if("undefined"!=typeof this.tracks){var t,e=this,s=e.selectedTrack;if(null!==s&&s.isLoaded){for(t=0;t<s.entries.times.length;t++)if(e.media.currentTime>=s.entries.times[t].start&&e.media.currentTime<=s.entries.times[t].stop)return e.captionsText.html(s.entries.text[t]).attr("class","mejs-captions-text "+(s.entries.times[t].identifier||"")),void e.captions.show().height(0);e.captions.hide()}else e.captions.hide()}},setupSlides:function(t){var e=this;e.slides=t,e.slides.entries.imgs=[e.slides.entries.text.length],e.showSlide(0)},showSlide:function(t){if("undefined"!=typeof this.tracks&&"undefined"!=typeof this.slidesContainer){var e=this,s=e.slides.entries.text[t],i=e.slides.entries.imgs[t];void 0===i||"undefined"==typeof i.fadeIn?e.slides.entries.imgs[t]=i=$('<img src="'+s+'">').on("load",function(){i.appendTo(e.slidesContainer).hide().fadeIn().siblings(":visible").fadeOut()}):i.is(":visible")||i.is(":animated")||i.fadeIn().siblings(":visible").fadeOut()}},displaySlides:function(){if("undefined"!=typeof this.slides){var t,e=this,s=e.slides;for(t=0;t<s.entries.times.length;t++)if(e.media.currentTime>=s.entries.times[t].start&&e.media.currentTime<=s.entries.times[t].stop)return void e.showSlide(t)}},displayChapters:function(){var t,e=this;for(t=0;t<e.tracks.length;t++)if("chapters"==e.tracks[t].kind&&e.tracks[t].isLoaded){e.drawChapters(e.tracks[t]),e.hasChapters=!0;break}},drawChapters:function(t){var e,s,i=this,n=0,a=0;for(i.chapters.empty(),e=0;e<t.entries.times.length;e++)s=t.entries.times[e].stop-t.entries.times[e].start,((n=Math.floor(s/i.media.duration*100))+a>100||e==t.entries.times.length-1&&n+a<100)&&(n=100-a),i.chapters.append($('<div class="mejs-chapter" rel="'+t.entries.times[e].start+'" style="left: '+a.toString()+"%;width: "+n.toString()+'%;"><div class="mejs-chapter-block'+(e==t.entries.times.length-1?" mejs-chapter-block-last":"")+'"><span class="ch-title">'+t.entries.text[e]+'</span><span class="ch-time">'+mejs.Utility.secondsToTimeCode(t.entries.times[e].start,i.options)+"&ndash;"+mejs.Utility.secondsToTimeCode(t.entries.times[e].stop,i.options)+"</span></div></div>")),a+=n;i.chapters.find("div.mejs-chapter").click(function(){i.media.setCurrentTime(parseFloat($(this).attr("rel"))),i.media.paused&&i.media.play()}),i.chapters.show()}}),mejs.language={codes:{af:"Afrikaans",sq:"Albanian",ar:"Arabic",be:"Belarusian",bg:"Bulgarian",ca:"Catalan",zh:"Chinese","zh-cn":"Chinese Simplified","zh-tw":"Chinese Traditional",hr:"Croatian",cs:"Czech",da:"Danish",nl:"Dutch",en:"English",et:"Estonian",fl:"Filipino",fi:"Finnish",fr:"French",gl:"Galician",de:"German",el:"Greek",ht:"Haitian Creole",iw:"Hebrew",hi:"Hindi",hu:"Hungarian",is:"Icelandic",id:"Indonesian",ga:"Irish",it:"Italian",ja:"Japanese",ko:"Korean",lv:"Latvian",lt:"Lithuanian",mk:"Macedonian",ms:"Malay",mt:"Maltese",no:"Norwegian",fa:"Persian",pl:"Polish",pt:"Portuguese",ro:"Romanian",ru:"Russian",sr:"Serbian",sk:"Slovak",sl:"Slovenian",es:"Spanish",sw:"Swahili",sv:"Swedish",tl:"Tagalog",th:"Thai",tr:"Turkish",uk:"Ukrainian",vi:"Vietnamese",cy:"Welsh",yi:"Yiddish"}},mejs.TrackFormatParser={webvtt:{pattern_timecode:/^((?:[0-9]{1,2}:)?[0-9]{2}:[0-9]{2}([,.][0-9]{1,3})?) --\> ((?:[0-9]{1,2}:)?[0-9]{2}:[0-9]{2}([,.][0-9]{3})?)(.*)$/,parse:function(t){for(var e,s,i,n=0,a=mejs.TrackFormatParser.split2(t,/\r?\n/),o={text:[],times:[]};n<a.length;n++){if((e=this.pattern_timecode.exec(a[n]))&&n<a.length){for(n-1>=0&&""!==a[n-1]&&(i=a[n-1]),s=a[++n],n++;""!==a[n]&&n<a.length;)s=s+"\n"+a[n],n++;s=$.trim(s).replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,"<a href='$1' target='_blank'>$1</a>"),o.text.push(s),o.times.push({identifier:i,start:0===mejs.Utility.convertSMPTEtoSeconds(e[1])?.2:mejs.Utility.convertSMPTEtoSeconds(e[1]),stop:mejs.Utility.convertSMPTEtoSeconds(e[3]),settings:e[5]})}i=""}return o}},dfxp:{parse:function(t){var e,s,i=0,n=(t=$(t).filter("tt")).children("div").eq(0),a=n.find("p"),o=t.find("#"+n.attr("style")),r={text:[],times:[]};if(o.length){var c=o.removeAttr("id").get(0).attributes;if(c.length)for(e={},i=0;i<c.length;i++)e[c[i].name.split(":")[1]]=c[i].value}for(i=0;i<a.length;i++){var l,d={start:null,stop:null,style:null};if(a.eq(i).attr("begin")&&(d.start=mejs.Utility.convertSMPTEtoSeconds(a.eq(i).attr("begin"))),!d.start&&a.eq(i-1).attr("end")&&(d.start=mejs.Utility.convertSMPTEtoSeconds(a.eq(i-1).attr("end"))),a.eq(i).attr("end")&&(d.stop=mejs.Utility.convertSMPTEtoSeconds(a.eq(i).attr("end"))),!d.stop&&a.eq(i+1).attr("begin")&&(d.stop=mejs.Utility.convertSMPTEtoSeconds(a.eq(i+1).attr("begin"))),e){l="";for(var p in e)l+=p+":"+e[p]+";"}l&&(d.style=l),0===d.start&&(d.start=.2),r.times.push(d),s=$.trim(a.eq(i).html()).replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,"<a href='$1' target='_blank'>$1</a>"),r.text.push(s),0===r.times.start&&(r.times.start=2)}return r}},split2:function(t,e){return t.split(e)}},3!="x\n\ny".split(/\n/gi).length&&(mejs.TrackFormatParser.split2=function(t,e){var s,i=[],n="";for(s=0;s<t.length;s++)n+=t.substring(s,s+1),e.test(n)&&(i.push(n.replace(e,"")),n="");return i.push(n),i})});